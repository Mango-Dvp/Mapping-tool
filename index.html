<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProMapper | Mango Automations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-canvas: #09090b;
            --sidebar-bg: #0c0c0e;
            --node-bg: #18181b;
            --accent: #5865f2; 
            --border: #27272a;
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
            background-color: var(--bg-canvas);
            color: #d4d4d8;
        }

        /* Canvas Layout */
        .canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            cursor: grab;
            overflow: hidden;
            background-image: radial-gradient(#1e1e21 1.2px, transparent 1.2px);
            background-size: 40px 40px;
        }

        .canvas-container:active { cursor: grabbing; }

        .canvas-content {
            position: absolute;
            transform-origin: 0 0;
            will-change: transform;
            width: 0px;
            height: 0px;
            top: 0;
            left: 0;
        }

        /* Sleek Node Style */
        .node {
            position: absolute;
            display: flex;
            align-items: center;
            height: 40px;
            padding: 0 16px;
            background: var(--node-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: transform 0.1s ease, border-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            min-width: 180px;
            user-select: none;
            cursor: pointer;
            z-index: 100;
        }

        .node:hover {
            border-color: #52525b;
            background: #1c1c21;
        }

        .node-active {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(88, 101, 242, 0.25);
            z-index: 200;
        }

        .node-linking {
            border-color: var(--accent);
            background: #1e1b4b;
            animation: pulse-node 1.5s infinite;
        }

        @keyframes pulse-node {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .link-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--accent);
            color: white;
            font-size: 9px;
            font-weight: 800;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        /* SVG Connections - Robust Rendering */
        #svg-layer {
            position: absolute;
            top: -100000px;
            left: -100000px;
            width: 200000px;
            height: 200000px;
            pointer-events: none;
            overflow: visible;
            z-index: 1;
        }

        .connector-line {
            fill: none;
            stroke: #5865f2;
            stroke-opacity: 0.8;
            stroke-width: 3;
            pointer-events: none;
            stroke-linecap: round;
        }

        /* Custom Glass UI */
        .glass-input {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px 14px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            outline: none;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .glass-input:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 15px rgba(88, 101, 242, 0.1), inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Sidebar & Layout */
        #sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            z-index: 40;
            display: flex;
            flex-direction: column;
        }

        .side-btn {
            @apply flex items-center gap-3 w-full px-4 py-2.5 rounded-xl transition-all text-left text-zinc-500 hover:text-zinc-100 hover:bg-white/5 text-[11px] font-semibold;
        }

        .side-title { @apply text-[10px] font-bold uppercase text-zinc-600 tracking-widest mt-8 mb-2 px-4 border-b border-white/5 pb-2 flex justify-between items-center; }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
        }

        kbd {
            @apply px-1.5 py-0.5 bg-zinc-800 border border-zinc-700 rounded text-[9px] font-bold text-zinc-500 mx-0.5 shadow-sm;
        }

        .thin-scroll::-webkit-scrollbar { width: 3px; }
        .thin-scroll::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        
        /* AI Prompt UI Section */
        .ai-card {
            @apply p-6 bg-white/[0.01] rounded-2xl border border-white/5 mb-6 text-xs leading-relaxed;
        }

        .chatgpt-btn {
            @apply flex items-center justify-center gap-2 w-full py-3 bg-zinc-100 hover:bg-white text-black rounded-xl font-bold text-xs transition-all shadow-lg;
        }

        .message-toast {
            @apply fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 bg-zinc-900 border border-white/10 rounded-2xl text-xs font-bold text-white shadow-2xl z-[200] opacity-0 transition-opacity pointer-events-none;
        }
    </style>
</head>
<body id="app-body" class="text-zinc-400">

    <div id="message-toast" class="message-toast"></div>

    <!-- TOP NAVIGATION -->
    <nav class="fixed top-0 left-0 right-0 h-16 bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900 flex items-center justify-between px-8 z-50">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-4 group">
                <div class="bg-white text-black p-2 rounded-lg shadow-lg">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-zinc-100 tracking-tight">ProMapper</h1>
                    <p class="text-[9px] text-zinc-600 font-bold uppercase tracking-widest">Mango Automations</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-zinc-900/50 p-1 rounded-xl border border-zinc-800">
                <button onclick="spacizeLayout()" class="flex items-center gap-3 px-5 py-2 hover:bg-white/5 rounded-lg transition-all text-xs font-bold text-zinc-400">
                    <i data-lucide="sparkles" class="w-4 h-4 text-blue-500"></i>
                    <span>Spacize</span>
                </button>
                <div class="w-[1px] h-6 bg-zinc-800 mx-1"></div>
                <button onclick="toggleImportModal()" class="flex items-center gap-3 px-5 py-2 hover:bg-white/5 rounded-lg transition-all text-xs font-bold text-zinc-400">
                    <i data-lucide="brain-circuit" class="w-4 h-4 text-indigo-400"></i>
                    <span>Sync AI manifest</span>
                </button>
                <div class="w-[1px] h-6 bg-zinc-800 mx-1"></div>
                <button onclick="clearWorkspace()" class="flex items-center gap-3 px-5 py-2 hover:bg-red-500/10 hover:text-red-400 rounded-lg transition-all text-xs font-bold text-zinc-400">
                    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                    <span>Clear all</span>
                </button>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div id="linking-toast" class="hidden flex items-center gap-3 px-6 py-1.5 bg-indigo-600 text-white rounded-lg text-[11px] font-bold shadow-lg animate-pulse">
                <i data-lucide="link" class="w-4 h-4"></i> Link mode active
            </div>

            <div class="flex items-center bg-zinc-900 border border-zinc-800 rounded-xl p-0.5 shadow-inner">
                <button onclick="zoomCanvas(0.8)" class="p-2 hover:bg-zinc-800 rounded text-zinc-500 transition-all"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button>
                <span id="zoom-label" class="text-[11px] font-bold px-4 w-16 text-center text-zinc-400">100%</span>
                <button onclick="zoomCanvas(1.2)" class="p-2 hover:bg-zinc-800 rounded text-zinc-500 transition-all"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button>
            </div>
            
            <button onclick="toggleFullscreen()" class="p-3 bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 rounded-xl text-zinc-400" title="Full workspace view">
                <i data-lucide="maximize" class="w-4 h-4"></i>
            </button>

            <button onclick="showExportModal()" class="flex items-center gap-3 px-8 py-2.5 bg-white text-black text-xs font-bold rounded-lg hover:bg-indigo-600 hover:text-white transition-all shadow-xl">
                Export
            </button>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed left-0 top-16 bottom-0 flex flex-col overflow-hidden">
        <div class="p-6 pb-2">
            <input type="text" id="element-search" placeholder="Search bot modules..." class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-5 py-3 text-xs outline-none focus:border-indigo-600 transition-all text-zinc-100" oninput="filterElements()">
            <button onclick="toggleCustomModal()" class="w-full mt-3 py-3 border border-zinc-800 text-zinc-500 rounded-xl text-[10px] font-bold hover:text-white hover:bg-white/5 transition-all">
                + Register custom unit
            </button>
        </div>
        
        <div id="sidebar-content" class="flex-1 overflow-y-auto thin-scroll p-4 pt-0">
            <!-- Dynamic Content -->
        </div>
        
        <div class="mt-auto p-6 border-t border-zinc-900 bg-black/40">
            <div class="text-[9px] text-zinc-700 font-bold uppercase tracking-widest space-y-2 opacity-50">
                <div class="flex justify-between items-center"><span>Link mode</span><kbd>Ctrl Shift H</kbd></div>
                <div class="flex justify-between items-center"><span>Deploy unit</span><kbd>Enter</kbd></div>
            </div>
        </div>
    </aside>

    <!-- PROPERTIES PANEL -->
    <aside id="node-editor" class="fixed right-8 top-24 bottom-8 w-96 bg-zinc-900 border border-zinc-800 rounded-[32px] shadow-2xl p-10 z-40 translate-x-[500px] transition-transform duration-500">
        <div class="flex justify-between items-center mb-10">
            <h3 id="active-node-name" class="text-xs font-bold uppercase tracking-widest text-zinc-500">Unit details</h3>
            <button onclick="closeEditor()" class="p-2 hover:bg-white/5 rounded-full text-zinc-600"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <div id="editor-fields" class="space-y-4 overflow-y-auto thin-scroll max-h-[calc(100vh-450px)] pr-2">
            <!-- Fields generated by JS -->
        </div>

        <div class="mt-8 border-t border-zinc-800 pt-8">
             <div id="color-picker" class="flex gap-3 flex-wrap mb-8"></div>
        </div>

        <div class="absolute bottom-10 left-10 right-10 flex flex-col gap-4">
            <button onclick="closeEditor()" class="w-full py-5 bg-white text-black rounded-2xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all shadow-xl">Apply changes</button>
            <button onclick="deleteSelectedNode()" class="w-full py-2 text-zinc-700 text-[11px] font-bold hover:text-red-500 transition-all uppercase tracking-widest">Delete unit</button>
        </div>
    </aside>

    <!-- CANVAS -->
    <main id="canvas-container" class="canvas-container" onmousedown="handleCanvasDown(event)" onwheel="handleWheel(event)" ondblclick="handleCanvasDblClick(event)">
        <div id="canvas-content" class="canvas-content">
            <svg id="svg-layer">
                <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orientation="auto"><path d="M0,0 L10,3.5 L0,7 Z" fill="#5865f2" /></marker></defs>
            </svg>
            <div id="nodes-container"></div>
        </div>
    </main>

    <!-- SYNC & AI ASSISTANT MODAL -->
    <div id="import-modal" class="fixed inset-0 z-[100] modal-overlay hidden flex items-center justify-center p-6" onclick="if(event.target === this) toggleImportModal()">
        <div class="bg-zinc-900 w-full max-w-5xl rounded-[48px] border border-zinc-800 shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="flex h-full">
                <!-- Left: Guide -->
                <div class="w-1/2 p-12 border-r border-white/5 overflow-y-auto thin-scroll">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                        <i data-lucide="wand-2" class="text-indigo-400"></i> AI architect assistant
                    </h2>
                    <p class="text-sm text-zinc-500 mb-8 font-medium">Use an AI like <a href="https://chat.openai.com" target="_blank" class="text-indigo-400 underline hover:text-indigo-300">ChatGPT</a> to design your bot. Copy the prompt below and paste it into your favorite chat model.</p>
                    
                    <div class="ai-card">
                        <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-3 block">1. Describe logic requirements</span>
                        <textarea id="user-ai-request" rows="3" placeholder="Describe the advanced flow (e.g., A session voting system with branching results)..." class="glass-input mb-4"></textarea>
                        <a href="https://chat.openai.com" target="_blank" class="chatgpt-btn">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5153-4.9066 6.0462 6.0462 0 0 0-4.4471-2.9143 6.0857 6.0857 0 0 0-5.414 1.3403 6.1105 6.1105 0 0 0-4.4452-1.9333 6.052 6.052 0 0 0-6.0424 6.056c0 1.5613.5978 3.03 1.6628 4.14a6.0123 6.0123 0 0 0-.5153 4.9066 6.052 6.052 0 0 0 4.4471 2.9143 6.0857 6.0857 0 0 0 5.414-1.3403 6.1105 6.1105 0 0 0 4.4452 1.9333 6.052 6.052 0 0 0 6.0424-6.056c0-1.5613-.5978-3.03-1.6628-4.14z"/></svg>
                            Open ChatGPT
                        </a>
                    </div>

                    <div class="ai-card">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-bold text-zinc-100 uppercase tracking-widest text-indigo-400">2. Copy architect instruction</span>
                            <button onclick="copyAIPrompt()" class="text-[10px] bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-500 transition-colors">Copy Prompt</button>
                        </div>
                        <div id="ai-prompt-preview" class="p-0 text-[10px] font-mono text-zinc-500 max-h-48 overflow-y-auto thin-scroll whitespace-pre-wrap">
                            [Prompt updates live]
                        </div>
                    </div>
                </div>

                <!-- Right: Paste area -->
                <div class="w-1/2 p-12 flex flex-col bg-black/20">
                    <h2 class="text-2xl font-bold text-white mb-6">Manifest build</h2>
                    <textarea id="import-text" placeholder='Paste logic JSON here...' class="glass-input flex-1 font-mono text-indigo-300 h-full mb-6"></textarea>
                    <div class="flex gap-4">
                        <button onclick="toggleImportModal()" class="flex-1 py-4 text-zinc-600 text-xs font-bold border border-zinc-800 rounded-3xl hover:bg-white/5 transition-all">Cancel</button>
                        <button onclick="handleTextImport()" class="flex-1 py-4 bg-white text-black rounded-3xl text-xs font-bold shadow-xl hover:bg-zinc-200 transition-all">Apply sync</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REGISTER MODAL -->
    <div id="custom-modal" class="fixed inset-0 z-[110] modal-overlay hidden flex items-center justify-center p-6" onclick="if(event.target === this) toggleCustomModal()">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[32px] border border-zinc-800 p-12 shadow-2xl">
            <h2 class="text-2xl font-bold mb-8 text-white">Register module</h2>
            <label class="text-[10px] font-bold text-zinc-600 uppercase mb-3 block tracking-widest">Display label</label>
            <input type="text" id="custom-title" placeholder="Economy unit" class="glass-input">
            <label class="text-[10px] font-bold text-zinc-600 uppercase mb-3 block tracking-widest">Lucide icon</label>
            <input type="text" id="custom-icon" placeholder="zap, box, or star" class="glass-input">
            <div class="flex gap-4 mt-8">
                <button onclick="toggleCustomModal()" class="flex-1 py-4 text-zinc-600 text-xs font-bold">Cancel</button>
                <button onclick="submitCustomElement()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl text-xs font-bold shadow-lg">Register</button>
            </div>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" class="fixed inset-0 z-[100] modal-overlay hidden flex items-center justify-center p-6" onclick="if(event.target === this) hideExportModal()">
        <div class="bg-zinc-900 w-full max-w-4xl rounded-[64px] border border-zinc-800 flex flex-col max-h-[85vh] shadow-2xl">
            <div class="p-12 border-b border-zinc-800 flex items-center justify-between">
                <h2 class="text-2xl font-bold text-white tracking-tight italic">Project manifest build</h2>
                <button onclick="hideExportModal()"><i data-lucide="x" class="w-8 h-8 text-zinc-700"></i></button>
            </div>
            <div class="p-12 flex-1 overflow-y-auto thin-scroll">
                <div class="grid grid-cols-2 gap-8 mb-12">
                    <button onclick="downloadJSON()" class="p-10 border border-zinc-800 rounded-3xl text-left hover:border-white transition-all group">
                        <h4 class="text-base font-bold group-hover:text-indigo-500 transition-colors uppercase tracking-widest">JSON build</h4>
                        <p class="text-[10px] text-zinc-700 font-bold uppercase tracking-widest mt-2">Full logic archive</p>
                    </button>
                    <button onclick="copyFlowJSON()" class="p-10 border border-zinc-800 rounded-3xl text-left hover:border-white transition-all group">
                        <h4 class="text-base font-bold group-hover:text-indigo-500 transition-colors uppercase tracking-widest">Copy JSON</h4>
                        <p class="text-[10px] text-zinc-700 font-bold uppercase tracking-widest mt-2">Clipboard manifest</p>
                    </button>
                </div>
                <pre id="export-preview" class="bg-black text-zinc-600 p-12 rounded-[40px] text-sm font-mono leading-relaxed border border-zinc-800"></pre>
            </div>
        </div>
    </div>

    <script>
        // --- Catalog Data ---
        const CATALOG = {
            'Triggers': [
                { id: 'ev_msg', icon: 'message-square', title: 'On Message' }, { id: 'ev_slash', icon: 'terminal', title: 'Slash Command' },
                { id: 'ev_join', icon: 'user-plus', title: 'User Join' }, { id: 'ev_leave', icon: 'user-minus', title: 'User Leave' },
                { id: 'ev_react', icon: 'smile', title: 'Reaction Add' }, { id: 'ev_ready', icon: 'power', title: 'Bot Ready' },
                { id: 'ev_cron', icon: 'clock', title: 'Interval' }, { id: 'ev_voice', icon: 'mic', title: 'Voice Join' }
            ],
            'Interaction': [
                { id: 'act_send', icon: 'send', title: 'Send Msg' }, { id: 'act_reply', icon: 'corner-up-left', title: 'Reply' },
                { id: 'act_embed', icon: 'layout', title: 'Build Embed' }, { id: 'act_dm', icon: 'mail', title: 'Direct Msg' },
                { id: 'act_btn', icon: 'mouse-pointer-2', title: 'Button' }, { id: 'act_modal', icon: 'columns', title: 'Show Modal' }
            ],
            'Moderation': [
                { id: 'mod_kick', icon: 'user-x', title: 'Kick User' }, { id: 'mod_ban', icon: 'lock', title: 'Ban User' },
                { id: 'mod_timeout', icon: 'clock', title: 'Set Timeout' }, { id: 'mod_purge', icon: 'trash-2', title: 'Purge Chat' },
                { id: 'mod_warn', icon: 'alert-triangle', title: 'Issue Warn' }, { id: 'mod_nick', icon: 'type', title: 'Set Nick' }
            ],
            'Logic Stacks': [
                { id: 'l_if', icon: 'split', title: 'Condition' }, { id: 'l_loop', icon: 'rotate-cw', title: 'Iteration' },
                { id: 'l_var', icon: 'box', title: 'Set Variable' }, { id: 'l_wait', icon: 'hourglass', title: 'Set Delay' },
                { id: 'f_get', icon: 'server', title: 'Fetch API' }, { id: 'f_db', icon: 'database', title: 'Database' }
            ],
            'Custom Modules': []
        };

        // --- System State ---
        let projects = JSON.parse(localStorage.getItem('am_studio_manifest_v26') || '{}');
        let currentProjectId = localStorage.getItem('am_active_id') || 'default';
        let nodes = [];
        let connections = [];
        let transform = { x: window.innerWidth/2, y: 150, scale: 1 };
        let isPanning = false;
        let startPos = { x: 0, y: 0 };
        let selectedId = null;
        let dragId = null;
        let dragOffset = { x: 0, y: 0 };
        let isLinkMode = false;
        let linkSequence = [];

        const COLORS = { blurple: '#5865F2', emerald: '#10b981', gold: '#FEE75C', red: '#ED4245', zinc: '#52525b' };

        window.onload = () => {
            lucide.createIcons();
            initSidebarResize();
            initColorPalette();
            filterElements(); 
            
            document.getElementById('user-ai-request').addEventListener('input', updateAIPromptPreview);

            if (Object.keys(projects).length === 0) {
                projects['default'] = { name: 'Main workspace', nodes: [], connections: [], transform: { x: window.innerWidth/2, y: 150, scale: 1 }, updated: Date.now() };
            }
            loadProject(currentProjectId);
            window.addEventListener('keydown', handleGlobalKeys);
        };

        // --- UI Operations ---
        function showMessage(msg) {
            const toast = document.getElementById('message-toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2500);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function clearWorkspace() {
            if(confirm("Wipe workspace logic?")) {
                nodes = []; connections = []; renderNodes(); renderConnections(); autoSave();
                showMessage("Workspace cleared.");
            }
        }

        function closeEditor() { 
            selectedId = null; 
            document.getElementById('node-editor').style.transform = 'translateX(500px)'; 
            renderNodes(); 
            autoSave(); 
        }

        function toggleCustomModal() { document.getElementById('custom-modal').classList.toggle('hidden'); }
        function toggleImportModal() { document.getElementById('import-modal').classList.toggle('hidden'); updateAIPromptPreview(); }

        // --- AI prompt logic ---
        function updateAIPromptPreview() {
            const req = document.getElementById('user-ai-request').value || "[Your specific request]";
            const availableNodes = Object.values(CATALOG).flat().map(n => n.id).join(', ');
            
            const promptStr = `You are a Discord Bot JSON GENERATER. Generate a JSON code for ProMapper (a way to fully visualize the way that a command, feature, or overall bot works).
Instructions:
1. Create a well-formatted advanced logic flow for: "${req}".
2. Support advanced branching (one node connecting to many others) and multiple actions happening at once.
3. Available module IDs (DO NOT USE OTHERS - BUT YOU CAN CREATE AS MANY CUSTOM AS POSIBLE): ${availableNodes}.
4. Format MUST be valid JSON matching this schema:
{
  "meta": { "name": "Generated Unit", "version": "1.0.0" },
  "nodes": [
    { "id": "unique_id", "type": "module_id_from_list", "title": "Label", "description": "Detailed Logic Content", "icon": "lucide_icon_name", "x": pos_x, "y": pos_y }
  ],
  "connections": [ { "from": "id1", "to": "id2" } ]
}
5. Every node MUST include a relevant "icon" string from Lucide (e.g. 'shield', 'zap', 'trash', 'user-plus', 'message-square').
Return ONLY the JSON block.`;

            document.getElementById('ai-prompt-preview').innerText = promptStr;
        }

        function copyAIPrompt() {
            const t = document.getElementById('ai-prompt-preview').innerText;
            const el = document.createElement("textarea"); el.value = t;
            document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            showMessage("Prompt copied.");
        }

        function filterElements() {
            const query = document.getElementById('element-search').value.toLowerCase();
            const content = document.getElementById('sidebar-content');
            content.innerHTML = '';
            Object.keys(CATALOG).forEach(cat => {
                const filtered = CATALOG[cat].filter(el => el.title.toLowerCase().includes(query));
                if (filtered.length > 0) {
                    const title = document.createElement('h3');
                    title.className = "side-title";
                    title.innerText = cat;
                    content.appendChild(title);
                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-2 gap-2";
                    filtered.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = "side-btn";
                        btn.onclick = () => addNode(item.id, item.icon, item.title);
                        btn.innerHTML = `<i data-lucide="${item.icon}"></i><span>${item.title}</span>`;
                        grid.appendChild(btn);
                    });
                    content.appendChild(grid);
                }
            });
            lucide.createIcons();
        }

        function submitCustomElement() {
            const title = document.getElementById('custom-title').value;
            const icon = document.getElementById('custom-icon').value;
            if (title && icon) {
                CATALOG['Custom Modules'].push({ id: 'cust_' + Date.now(), icon, title });
                filterElements(); toggleCustomModal();
                showMessage("Unit registered.");
            }
        }

        // --- Core Engine ---
        function loadProject(id) {
            currentProjectId = id;
            localStorage.setItem('am_active_id', id);
            const p = projects[id] || projects['default'];
            nodes = p.nodes || []; connections = p.connections || [];
            transform = p.transform || { x: window.innerWidth/2, y: 150, scale: 1 };
            updateCanvasTransform(); renderNodes(); renderConnections();
        }

        function autoSave() {
            if (!projects[currentProjectId]) return;
            projects[currentProjectId] = { name: "Main Build", nodes, connections, transform, updated: Date.now() };
            localStorage.setItem('am_studio_v25', JSON.stringify(projects));
        }

        function goToHome() { loadProject(currentProjectId); showMessage("Workspace synced."); }

        function handleGlobalKeys(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.ctrlKey && e.shiftKey && e.code === 'KeyH') {
                e.preventDefault(); 
                isLinkMode = !isLinkMode; linkSequence = [];
                document.getElementById('linking-toast').classList.toggle('hidden', !isLinkMode);
                renderNodes();
            }
            if (e.key === 'Enter') { if(isLinkMode) confirmBatchLink(); else closeEditor(); }
            if (e.key === 'Escape') { isLinkMode = false; closeEditor(); renderNodes(); }
            if (e.key === 'Backspace' || e.key === 'Delete') deleteSelectedNode();
        }

        function confirmBatchLink() {
            if (linkSequence.length < 2) return;
            for (let i = 0; i < linkSequence.length - 1; i++) {
                const from = linkSequence[i], to = linkSequence[i+1];
                const exists = connections.findIndex(c => c.from === from && c.to === to);
                if (exists === -1) connections.push({ from, to });
                else connections.splice(exists, 1);
            }
            isLinkMode = false; linkSequence = [];
            document.getElementById('linking-toast').classList.add('hidden');
            renderNodes(); renderConnections(); autoSave();
        }

        function handleNodeInteract(id, e) {
            e.stopPropagation();
            if (isLinkMode) {
                if(linkSequence.includes(id)) linkSequence.splice(linkSequence.indexOf(id), 1);
                else linkSequence.push(id);
                renderNodes();
            } else { selectNode(id); startNodeDrag(id, e); }
        }

        function renderNodes() {
            const container = document.getElementById('nodes-container');
            if (!container) return;
            container.innerHTML = '';
            nodes.forEach(n => {
                const el = document.createElement('div');
                const lIdx = linkSequence.indexOf(n.id);
                el.className = `node ${selectedId === n.id ? 'node-active' : ''} ${lIdx > -1 ? 'node-linking' : ''}`;
                el.style.left = n.x + 'px'; el.style.top = n.y + 'px'; el.id = n.id;
                el.innerHTML = `<div style="color: ${n.color || '#3b82f6'}"><i data-lucide="${n.icon || 'circle'}" class="w-4 h-4"></i></div><span class="text-[10px] font-bold text-zinc-300 uppercase tracking-tight whitespace-nowrap ml-3">${n.title}</span>${lIdx > -1 ? `<div class="link-badge">${lIdx + 1}</div>` : ''}`;
                el.onmousedown = (e) => handleNodeInteract(n.id, e);
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderConnections() {
            const svg = document.getElementById('svg-layer');
            if (!svg) return;
            // Draw relative indigo lines inside the scaled workspace
            svg.innerHTML = `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orientation="auto"><path d="M0,0 L10,3.5 L0,7 Z" fill="#5865f2" /></marker></defs>`;
            connections.forEach(c => {
                const f = nodes.find(n => n.id === c.from), t = nodes.find(n => n.id === c.to);
                if (f && t) {
                    const offset = 200000;
                    const x1 = f.x + 90 + offset, y1 = f.y + 19 + offset, x2 = t.x + 90 + offset, y2 = t.y + offset;
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    const cpY = (y1 + y2) / 2;
                    path.setAttribute("d", `M ${x1} ${y1} C ${x1} ${cpY}, ${x2} ${cpY}, ${x2} ${y2}`);
                    path.setAttribute("class", "connector-line");
                    path.setAttribute("marker-end", "url(#arrowhead)");
                    svg.appendChild(path);
                }
            });
        }

        // --- Transformation Engine ---
        function updateCanvasTransform() {
            const c = document.getElementById('canvas-content');
            if (!c) return;
            c.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
            document.getElementById('zoom-label').innerText = Math.round(transform.scale * 100) + '%';
        }
        function handleWheel(e) { e.preventDefault(); const f = e.deltaY > 0 ? 0.94 : 1.06; zoomCanvas(f, e.clientX, e.clientY); }
        function zoomCanvas(f, cx, cy) {
            const ns = Math.min(Math.max(transform.scale * f, 0.05), 3);
            const wx = (cx - transform.x) / transform.scale, wy = (cy - transform.y) / transform.scale;
            transform.scale = ns; transform.x = cx - wx * ns; transform.y = cy - wy * ns; updateCanvasTransform();
        }
        function handleCanvasDown(e) { if (e.target.closest('.node')) return; isPanning = true; startPos = { x: e.clientX - transform.x, y: e.clientY - transform.y }; window.addEventListener('mousemove', onCanvasPan); window.addEventListener('mouseup', () => { isPanning = false; autoSave(); }); }
        function onCanvasPan(e) { if (!isPanning) return; transform.x = e.clientX - startPos.x; transform.y = e.clientY - startPos.y; updateCanvasTransform(); }
        function startNodeDrag(id, e) { dragId = id; const n = nodes.find(n => n.id === id); dragOffset = { x: e.clientX/transform.scale - n.x, y: e.clientY/transform.scale - n.y }; window.addEventListener('mousemove', onNodeDrag); window.addEventListener('mouseup', () => { dragId = null; autoSave(); }); }
        function onNodeDrag(e) { if (!dragId) return; const n = nodes.find(n => n.id === dragId); n.x = e.clientX/transform.scale - dragOffset.x; n.y = e.clientY/transform.scale - dragOffset.y; const el = document.getElementById(dragId); if(el) { el.style.left = n.x + 'px'; el.style.top = n.y + 'px'; renderConnections(); } }
        function handleCanvasDblClick(e) { if(e.target.closest('.node')) return; addNode('ev_ready', 'power', 'Initialize'); }
        function resetView() { transform = { x: window.innerWidth / 2, y: 150, scale: 1 }; updateCanvasTransform(); }

        function addNode(type, icon, title) {
            const id = 'n_' + Date.now();
            const wx = (window.innerWidth/2 - transform.x)/transform.scale - 80;
            const wy = (window.innerHeight/2 - transform.y)/transform.scale - 17;
            nodes.push({ id, type, icon, title, props: { title, logic: '' }, x: wx, y: wy, color: COLORS.zinc });
            renderNodes(); selectNode(id); autoSave();
        }

        function selectNode(id) {
            selectedId = id;
            const node = nodes.find(n => n.id === id);
            const editor = document.getElementById('editor-fields');
            editor.innerHTML = '';
            if (node) {
                const fields = [{ label: 'Unit label', key: 'title', type: 'text' }, { label: 'Logic Config', key: 'logic', type: 'textarea' }];
                fields.forEach(f => {
                    const wrap = document.createElement('div');
                    wrap.innerHTML = `<label class="text-[10px] font-bold text-zinc-600 uppercase mb-2 block tracking-widest">${f.label}</label>`;
                    const input = f.type === 'textarea' ? document.createElement('textarea') : document.createElement('input');
                    if(f.type === 'textarea') input.style.height = '140px';
                    input.className = "glass-input thin-scroll";
                    input.value = (f.key === 'title' ? node.title : (node.props?.[f.key] || ''));
                    input.oninput = (e) => {
                        if(f.key === 'title') node.title = e.target.value;
                        else { if(!node.props) node.props = {}; node.props[f.key] = e.target.value; }
                        renderNodes();
                    };
                    wrap.appendChild(input);
                    editor.appendChild(wrap);
                });
                document.getElementById('node-editor').style.transform = 'translateX(0)';
            }
            renderNodes();
        }

        function deleteSelectedNode() { if (!selectedId) return; nodes = nodes.filter(n => n.id !== selectedId); connections = connections.filter(c => c.from !== selectedId && c.to !== selectedId); closeEditor(); renderConnections(); }

        function spacizeLayout() {
            if(!nodes.length) return;
            const startNodes = nodes.filter(n => !connections.some(c => c.to === n.id));
            const visited = new Set(), levels = {};
            function traverse(id, level) {
                if (visited.has(id)) return;
                visited.add(id); if (!levels[level]) levels[level] = [];
                levels[level].push(id);
                connections.filter(c => c.from === id).forEach(c => traverse(c.to, level + 1));
            }
            startNodes.forEach(n => traverse(n.id, 0));
            Object.keys(levels).forEach(l => {
                const nInL = levels[l];
                nInL.forEach((id, i) => { const n = nodes.find(node => node.id === id); n.x = (i * 300) - ((nInL.length - 1) * 150); n.y = l * 200 + 200; });
            });
            resetView(); renderNodes(); renderConnections(); autoSave();
        }

        function handleTextImport() {
            try {
                const raw = document.getElementById('import-text').value;
                const d = JSON.parse(raw);
                const nodesToLoad = d.nodes || [];
                const connsToLoad = d.connections || [];
                nodesToLoad.forEach(node => {
                    if (!node.props) node.props = {};
                    if (node.description && !node.props.logic) node.props.logic = node.description;
                });
                nodes = nodesToLoad; connections = connsToLoad;
                resetView(); renderNodes(); renderConnections(); toggleImportModal(); autoSave();
                showMessage("Sync successful.");
            } catch(e) { showMessage("Format error."); }
        }

        function downloadJSON() {
            const data = { header: "GUIDE: registerCustomElement('Category', 'id', 'icon', 'Title')", nodes, connections };
            const b = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'build.json'; a.click();
        }

        function copyFlowJSON() {
            const t = JSON.stringify({nodes, connections}, null, 2);
            const el = document.createElement("textarea"); el.value = t;
            document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            showMessage("Manifest JSON copied.");
        }

        function initSidebarResize() {
            const sidebar = document.getElementById('sidebar');
            const resizer = document.createElement('div');
            resizer.className = "absolute right-0 top-0 w-1 h-full cursor-col-resize hover:bg-indigo-500 transition-colors z-50";
            sidebar.appendChild(resizer);
            let resizing = false;
            resizer.onmousedown = () => resizing = true;
            window.onmousemove = (e) => { if(resizing && e.clientX > 100 && e.clientX < 500) sidebar.style.width = e.clientX + 'px'; };
            window.onmouseup = () => resizing = false;
        }

        function initColorPalette() {
            const container = document.getElementById('color-picker');
            Object.values(COLORS).forEach(hex => {
                const b = document.createElement('button');
                b.className = "w-7 h-7 rounded border border-white/5 transition-all hover:scale-110";
                b.style.backgroundColor = hex;
                b.onclick = () => { if(selectedId) { nodes.find(n => n.id === selectedId).color = hex; renderNodes(); autoSave(); } };
                container.appendChild(b);
            });
        }
        function showExportModal() { 
            const manifest = JSON.stringify({nodes, connections}, null, 2);
            document.getElementById('export-modal').classList.remove('hidden'); 
            document.getElementById('export-preview').innerText = manifest; 
        }
        function hideExportModal() { document.getElementById('export-modal').classList.add('hidden'); }
    </script>
</body>
</html>
